<!DOCTYPE html>
<html>
<head>
    <link rel="stylesheet" type="text/css" href="/styles.css">
    <!-- Add Bootstrap CSS -->
    <link rel="stylesheet" href="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/css/bootstrap.min.css">
    <!-- Add Bootstrap JavaScript and jQuery (optional) -->
    <script src="https://code.jquery.com/jquery-3.5.1.slim.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@popperjs/core@2.5.3/dist/umd/popper.min.js"></script>
    <script src="https://stackpath.bootstrapcdn.com/bootstrap/4.5.2/js/bootstrap.min.js"></script>

    <title>Bitprop Rent Roll</title>
</head>
<body>
    <nav class="navbar">
        <!-- Title on the left -->
        <a class="navbar-brand" href="#">Bitprop</a>
    
        <!-- Centered buttons -->
         <!-- Rent Roll and Upload Transactions on the right -->
        <!-- Rent Roll button -->
        <button id="rentRoll" class="btn btn-primary custom-btn">Rent Roll</button>

        <!-- Upload Transactions button that links to another page -->
        <button id="uploadTransactions" class="btn btn-primary custom-btn" style="color: #fff;"><a href="upload_transactions.html">Upload Transactions</a></button>

    
        <!-- Dropdown menu with other buttons on the far right -->
        <div class="dropdown ml-auto">
            <button class="btn btn-primary dropdown-toggle" type="button" id="dropdownMenuButton" data-toggle="dropdown" aria-haspopup="true" aria-expanded="false">
                More
            </button>
            <div class="dropdown-menu dropdown-menu-right" aria-labelledby="dropdownMenuButton">
                <!-- Add all buttons in the dropdown menu -->
                <button id="tableProperties" class="btn btn-primary dropdown-item">Properties</button>
                <button id="tableRentalUnits" class="btn btn-primary dropdown-item">Rental Units</button>
                <button id="tableTransactions" class="btn btn-primary dropdown-item">Transactions</button>
                <button id="tableInvoices" class="btn btn-primary dropdown-item">Invoices</button>
                <button id="tableInvoicePayments" class="btn btn-primary dropdown-item">Invoice Payments</button>
                <button id="tableDeposits" class="btn btn-primary dropdown-item">Deposits</button>
                <button id="tableDepositInterest" class="btn btn-primary dropdown-item">Deposit Interest</button>
                <button id="tableInterestRates" class="btn btn-primary dropdown-item">Interest Rates</button>
                <button id="tableDeductions" class="btn btn-primary dropdown-item">Deductions</button>
                <button id="tableCitiq" class="btn btn-primary dropdown-item">Citiq</button>
                <button id="tableHomeownerPayouts" class="btn btn-primary dropdown-item">Homeowner Payouts</button>
            </div>
        </div>
    </nav>
    

    <!-- Filter and search inputs -->
    <div class="container mt-3">
        <div class="row">
            <div class="col-md-4">
                <label for="itemsPerPage">Items per page:</label>
                <select id="itemsPerPage" class="form-control">
                    <option value="10">10</option>
                    <option value="50">50</option>
                    <option value="100">100</option>
                    <option value="300">300</option>
                </select>
            </div>
            <div class="col-md-4">
                <!-- Filter by Month dropdown -->
                <label for="filterMonth">Filter by Month:</label>
                <select id="filterMonth" class="form-control">
                    <option value="">All</option>
                    <option value="1">January</option>
                    <option value="2">February</option>
                    <option value="3">March</option>
                    <option value="4">April</option>
                    <option value="5">May</option>
                    <option value="6">June</option>
                    <option value="7">July</option>
                    <option value="8">August</option>
                    <option value="9">September</option>
                    <option value="10">October</option>
                    <option value="11">November</option>
                    <option value="12">December</option>->
                </select>
            </div>
            <div class="col-md-4">
                <!-- Filter by Homeowner input -->
                <label for="filterHomeowner">Filter by Homeowner:</label>
                <input type="text" id="filterHomeowner" class="form-control" placeholder="Enter Homeowner">
            </div>
        </div>
    </div>

    <!-- Container to display table data -->
    <div id="functionData" class="container mt-4"></div>

    <!-- Comment Modal -->
    <div class="modal fade" id="commentModal" tabindex="-1" role="dialog" aria-labelledby="commentModalLabel" aria-hidden="true">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="commentModalLabel">Add Comment</h5>
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close">
                        <span aria-hidden="true">&times;</span>
                    </button>
                </div>
                <div class="modal-body">
                    <!-- Add your comment input field here -->
                    <div class="form-group">
                        <label for="comment">Comment:</label>
                        <textarea class="form-control" id="comment" rows="4"></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-secondary" id="saveComment">Save Comment</button>
                </div>
            </div>
        </div>
    </div>

    <!-- JavaScript functions -->
    <script>
        // Declare variables for modal elements
        const commentModal = document.getElementById('commentModal');
        const commentTextarea = document.getElementById('comment');
        const saveCommentButton = document.getElementById('saveComment');
        let currentInvoiceId = null; // Store the currently selected invoice ID

        console.log('Script is running');
        document.addEventListener('DOMContentLoaded', () => {
            console.log('The page has loaded');
            let currentTableData = []; // Define currentTableData in the outer scope

            // Reference to the filter input elements
            const filterInput = document.getElementById('tableFilter');
            const filterMonthInput = document.getElementById('filterMonth');
            const filterHomeownerInput = document.getElementById('filterHomeowner');
            filterHomeownerInput.addEventListener('keyup', (event) => {
                if (event.key === 'Enter') {
                    event.preventDefault();
                    // Call the function to filter the table based on the entered homeowner
                    filterTableByHomeowner(filterHomeownerInput.value);
                }
            });

            const searchInput = document.getElementById('tableSearch');
            // Reference to the "Items per page" dropdown
            const itemsPerPageSelect = document.getElementById('itemsPerPage');
            itemsPerPageSelect.value = 300;
            let selectedTable = ''; // Store the selected table name
            // selectedTable = 'Rent Roll';
            // Function to display a loading indicator in the Rent Roll view
            function showLoadingIndicator() {
                const functionDataDiv = document.getElementById('functionData');
                functionDataDiv.innerHTML = '<h2>Rent Roll</h2><p>Loading...</p>';
            }

            selectedTable = 'Rent Roll';
            showLoadingIndicator();
            setTimeout(() => {
                fetchAndEnhanceRentRollView();
            }, 1000);
            
            // Event listeners for filter elements
            filterMonthInput.addEventListener('change', () => {
                // Call the function to update the Rent Roll view based on the selected month filter
                fetchAndEnhanceRentRollView();
            });

            function filterTableByHomeowner(homeowner, table) {
                if (selectedTable === 'Rent Roll') {
                    // Get the table body element where the data rows are located
                    const tableBody = document.querySelector('.table tbody');

                    // Get all the rows in the table
                    const rows = tableBody.querySelectorAll('tr');

                    // Loop through each row and check the homeowner column
                    rows.forEach((row) => {
                        const homeownerCell = row.querySelector('td:nth-child(3)'); // Assuming the homeowner's name is in the 3rd column
                        if (homeownerCell) {
                            const homeownerName = homeownerCell.textContent.toLowerCase(); // Convert to lowercase for case-insensitive comparison
                            if (homeownerName.includes(homeowner.toLowerCase())) {
                                // Show the row if the homeowner's name matches the entered text
                                row.style.display = '';
                            } else {
                                // Hide the row if the homeowner's name doesn't match
                                row.style.display = 'none';
                            }
                        }
                    });
                }      
            }

            // Function to fetch data from a specific table
            async function fetchDataFromTable(tableName) {
                try {
                    console.log(`Fetching data for table: ${tableName}`);
                    const response = await fetch(`https://dashboard-function-app-1.azurewebsites.net/api/fetchTables?code=NDSzDsOxTUCabaFAoZuz7mGdVDsmFpPJTNyxAt1kh2uAAzFuHFzKww==&&table=${tableName}`); // Replace with the correct API endpoint
                    if (!response.ok) {
                        throw new Error('Error fetching data');
                    }

                    const data = await response.json();
                    console.log(`Data fetched for table: ${tableName}`);
                    return data;

                    
                } catch (error) {
                    console.error(`Error fetching data for ${tableName}:`, error);
                    return [];
                }
            }

            // Function to render an HTML table
            function renderTable(tableName, tableData) {
                console.log(`Rendering table for: ${tableName}`);
                const tableDiv = document.createElement('div');
                tableDiv.innerHTML = `<h2>${tableName}</h2>`;

                if (tableData.length === 0) {
                    tableDiv.innerHTML += '<p>No data available.</p>';
                    return tableDiv;
                }

                const table = document.createElement('table');
                // Add a class to the table element
                table.classList.add('rent-roll-table'); // Replace 'custom-table' with your desired class name
                const headerRow = table.insertRow();
                console.log('CREATING TABLE');
                for (const key in tableData[0]) {
                    const headerCell = headerRow.insertCell();
                    headerCell.innerText = key;
                    const className = key.toLocaleLowerCase();
                    headerCell.classList.add(className);

                    // Log the class name to the console
                    console.log(`Class '${className}' assigned to header cell`);

                    headerCell.addEventListener('click', () => {
                        // Implement sorting logic here for the clicked column
                        // You can sort the tableData array in-place
                        // After sorting, call populateTable to refresh the table with sorted data
                    });
                }

                tableData.forEach((rowData) => {
                    const row = table.insertRow();
                    for (const key in rowData) {
                        const cell = row.insertCell();
                        cell.innerText = rowData[key];
                    }
                    row.style.display = '';
                });

                tableDiv.appendChild(table);
                return tableDiv;
            }

            let filteredTableData = [];
            
            // Function to add filter and search functionality to the dynamically generated table
            function enhanceTableWithFeatures(tableName, tableData) {
                // Reference to the filter input element
                const filterInput = document.getElementById('tableFilter');
                // Reference to the search input element
                const searchInput = document.getElementById('tableSearch');

                // Function to populate the table with data
                function populateTable(data) {
                    console.log(`Populating table with data for: ${tableName}`);
                    const tableDiv = document.createElement('div');
                    tableDiv.innerHTML = `<h2>${tableName}</h2>`;
                    if (filterInput) {
                        tableDiv.appendChild(filterInput); // Add filter input to the table div
                    }
                    if (searchInput) {
                        tableDiv.appendChild(searchInput); // Add search input to the table div
                    }
                    const table = document.createElement('table');
                    table.classList.add('table'); // Add a class to the table element

                    // Add table headers
                    const headerRow = table.insertRow();
                    for (const key in data[0]) {
                        const headerCell = headerRow.insertCell();
                        headerCell.innerText = key;
                        console.log("Creating table");

                        // Attach event listener for sorting (click on column headers)
                        headerCell.addEventListener('click', () => {
                          if (key === 'month' || key === 'homeowner') {
                            // Sort by "month" or "homeowner"
                            tableData.sort((a, b) => {
                                if (a[key] < b[key]) {
                                    return -1;
                                }
                                if (a[key] > b[key]) {
                                    return 1;
                                }
                                return 0;
                            });
                            // Implement sorting logic here for the clicked column
                            // You can sort the tableData array in-place
                            // After sorting, call populateTable to refresh the table with sorted data
                          }

                          // Call populateTable to refresh the table with sorted data
                          const selectedItemsPerPage = parseInt(itemsPerPageSelect.value, 10);
                          filterTableByItemsPerPage(selectedItemsPerPage);

                        })
                    }
                  

                    // Clear table content
                    while (table.rows.length > 1) {
                        table.deleteRow(1);
                    }

                    // Add table rows
                    data.forEach((rowData) => {
                        const row = table.insertRow();
                        for (const key in rowData) {
                            const cell = row.insertCell();
                            cell.innerText = rowData[key];
                        }
                    });
                    if (selectedTable === 'Rent Roll') {
                        filterInput.addEventListener ('input', () => {
                            filterTableByHomeowner(filterInput.value, table);
                        });
                    }
                    

                    tableDiv.appendChild(table);

                    return tableDiv;
                }

                return populateTable(tableData);
            }

            // Function to fetch and display data from the selected table
            async function fetchAndEnhanceTable(tableName) {
                try {
                    console.log(`Fetching and enhancing table for: ${tableName}`);
                    const data = await fetchDataFromTable(tableName);
                    const functionDataDiv = document.getElementById('functionData');
                    // Clear the existing content
                    functionDataDiv.innerHTML = '';
                    if (data.length === 0) {
                        functionDataDiv.innerHTML = `<h2>${tableName}</h2><p>Loading / No data available.</p>`;
                    } else {
                        // Set currentTableData
                        currentTableData = data;

                        // Enhance the table with features
                        console.log(`Enhancing table with features for: ${tableName}`);
                        const tableDiv = enhanceTableWithFeatures(tableName, data);
                        functionDataDiv.appendChild(tableDiv);

                        // Filter the table based on the default or selected items per page
                        const selectedItemsPerPage = parseInt(itemsPerPageSelect.value, 10);
                        // Log the selected value to check if it's correctly initialized
                        console.log('Initial Items Per Page:', selectedItemsPerPage);
                        filterTableByItemsPerPage(selectedItemsPerPage);
                    }
                } catch (error) {
                    console.error(`Error fetching and enhancing table for ${tableName}:`, error);
                }
            }

            // Function to filter the table by items per page
            function filterTableByItemsPerPage(selectedItemsPerPage) {
                // Update the table to display the selected number of items per page
                const startIndex = 0; // Starting index
                const endIndex = startIndex + selectedItemsPerPage;

                // Ensure that the endIndex does not exceed the tableData length
                const limitedTableData = currentTableData.slice(startIndex, endIndex);

                // Populate the table with the limited data
                console.log(`Filtering table by Items Per Page: ${selectedItemsPerPage}`);
                const functionDataDiv = document.getElementById('functionData');
                functionDataDiv.innerHTML = ''; // Clear the existing content
                const tableDiv = enhanceTableWithFeatures(selectedTable, limitedTableData);
                functionDataDiv.appendChild(tableDiv);
            }

            // Attach event listeners to the table buttons
            const tableButtons = [
                'Properties',
                'RentalUnits',
                'Transactions',
                'Invoices',
                'InvoicePayments',
                'Deposits',
                'DepositInterest',
                'InterestRates',
                'Deductions',
                'Citiq',
                'HomeownerPayouts'
            ];

            tableButtons.forEach((tableName) => {
                const button = document.getElementById(`table${tableName}`);
                if (button) {
                    button.addEventListener('click', () => {
                        // Set the default "Items per page" value (e.g., 3)
                        itemsPerPageSelect.value = '300';
                        selectedTable = tableName; // Update the selected table
                        console.log(`Button clicked for table: ${tableName}`);
                        fetchAndEnhanceTable(tableName);
                    });
                }
            });

            const rentRollButton = document.getElementById('rentRoll');
            if (rentRollButton) {
                rentRollButton.addEventListener('click', () => {
                    // Set the default "Items per page" value (e.g., 3)
                    itemsPerPageSelect.value = '300';
                    selectedTable = 'Rent Roll'; // Update the selected table
                    console.log('Button clicked for table: Rent Roll');
                    fetchAndEnhanceRentRollView();
                });
            }

            // Function to fetch and display data for the new view (Invoices with invoice_type = 'rent')
            async function fetchAndEnhanceRentRollView() {
                try {
                    console.log('Fetching and enhancing Rent Roll view');
  
                    const selectedMonth = filterMonthInput.value;
                    const selectedHomeowner = filterHomeownerInput.value;
                    
                    // Construct the API endpoint URL with query parameters
                    let apiUrl = 'https://dashboard-function-app-1.azurewebsites.net/api/rentRoll?code=N--G6_gY23Znla-XYPXaZ18UqoLlQiA1ujeJcdyrUKupAzFushCcUg==';
                    if (selectedMonth) {
                        apiUrl += `&month=${encodeURIComponent(selectedMonth)}`;
                    }
                    if (selectedHomeowner) {
                        apiUrl += `&homeowner=${encodeURIComponent(selectedHomeowner)}`;
                    }

                    const data = await fetchRentRollData(apiUrl); // Pass the constructed URL
                    const functionDataDiv = document.getElementById('functionData');
                    // Clear the existing content
                    functionDataDiv.innerHTML = '';
                    if (data.length === 0) {
                        functionDataDiv.innerHTML = '<h2>Rent Roll</h2><p>No data available.</p>';
                    } else {
                        // Sort the data by month and homeowner
                        data.sort((a, b) => {
                            if (a.month < b.month) {
                                return -1;
                            } else if (a.month > b.month) {
                                return 1;
                            } else {
                                return a.homeowner.localeCompare(b.homeowner);
                            }
                        });
                        // Set currentTableData
                        currentTableData = data;

                        // Enhance the view with features
                        console.log('Enhancing Rent Roll view with features');
                        const viewDiv = enhanceRentRollView(data);
                        console.log('viewDiv:' + viewDiv);
                        functionDataDiv.appendChild(viewDiv);

                        // applyRowStyling(data, viewDiv.querySelector('table > body'));
                    }
                } catch (error) {
                    console.error('Error fetching and enhancing Rent Roll view:', error);
                }
            }


            // Create a new function to fetch data for the Invoices (Rent) view
            async function fetchRentRollData() {
                try {
                    console.log('Fetching Rent Roll view data');
                    const response = await fetch('https://dashboard-function-app-1.azurewebsites.net/api/rentRoll?code=N--G6_gY23Znla-XYPXaZ18UqoLlQiA1ujeJcdyrUKupAzFushCcUg=='); // Replace with the correct API endpoint
                    if (!response.ok) {
                        throw new Error('Error fetching data');
                    }

                    const data = await response.json();
                    console.log('Data fetched for Rent Roll view');
                    console.log(data);
                    return data;
                } catch (error) {
                    console.error('Error fetching Rent Roll view data:', error);
                    return [];
                }
            }

            // Create a new function to render the Rent Roll view as a table
            function enhanceRentRollView(data) {
                console.log('Enhancing Rent Roll view');
                const viewDiv = document.createElement('div');
                viewDiv.innerHTML = '<h2>Rent Roll</h2>';

                if (data.length === 0) {
                    viewDiv.innerHTML += '<p>No data available.</p>';
                    return viewDiv;
                }

                // Create a table element
                const table = document.createElement('table');
                table.classList.add('table', 'rent-roll-table'); // Add a class to the table element

                

                // Function to convert snake_case to Title Case
                function toTitleCase(snakeCase) {
                    return snakeCase
                        .split('_')
                        .map((word) => word.charAt(0).toUpperCase() + word.slice(1))
                        .join(' ');
                }
                const columnNames = ['invoice_id', 'unit_ref', 'homeowner', 'month', 'amount_due', 'amount_paid', 'date_paid', 'transaction_ref', 'comments'];
                // Create headers for each column
                // Create table headers
                const headerRow = table.insertRow();
                columnNames.forEach((columnName) => {
                    const headerCell = headerRow.insertCell();
                    headerCell.innerText = toTitleCase(columnName);
                    // headerCell.classList.add(columnName.toLowerCase());
                    // headerCell.setAttribute('data-column', columnName);
                });

                // Add a new header for the "Add Comment" button
                const addCommentHeaderCell = headerRow.insertCell();
                addCommentHeaderCell.innerText = 'Add Comment';

                // Populate the table with data
                data.forEach((invoice) => {
                    const row = table.insertRow();
                    columnNames.forEach((columnName) => {
                        const cell = row.insertCell();
                        
                        if (columnName === 'unit_ref') {
                            const unitRefLink = document.createElement('a');
                            unitRefLink.href = `unit_deposits.html?unit_ref=${invoice.unit_ref}`;
                            unitRefLink.textContent = invoice.unit_ref;

                            cell.appendChild(unitRefLink);
                        } else {
                            cell.innerText = invoice[columnName];
                        }
                        cell.classList.add(columnName.toLowerCase());
                        if (cell.textContent === '0' && cell.classList.contains('amount_paid')) {
                            cell.classList.add('zero-amount');
                        }
                    });


                    // Add the "Add Comment" button in the last column
                    const addButtonCell = row.insertCell();
                    const addButton = document.createElement('button');
                    addButton.innerText = 'Add Comment';
                    addButton.addEventListener('click', () => {
                        // Set the current invoice ID
                        console.log('Button clicked');
                        currentInvoiceId = invoice['invoice_id']; // Replace 'your_invoice_id_column_name' with the actual column name containing the invoice ID

                        // Open the comment modal
                        $(commentModal).modal('show');
                    });
                    addButtonCell.appendChild(addButton);
                });

                // });

                viewDiv.appendChild(table);

                // // Create a dummy div for testing
                // const dummyDiv = document.createElement('div');
                // dummyDiv.innerText = 'This is a dummy div for testing purposes';
                // viewDiv.appendChild(dummyDiv);
                return viewDiv;
            }


            // Add event listener for "Items per page" dropdown change
            itemsPerPageSelect.addEventListener('change', () => {
                const selectedItemsPerPage = parseInt(itemsPerPageSelect.value, 10);
                console.log('Items Per Page changed:', selectedItemsPerPage);
                filterTableByItemsPerPage(selectedItemsPerPage);
            });
            // Load the Properties table by default when the page loads
            fetchAndEnhanceTable(selectedTable);

            // Event listener for the "Save Comment" button
            saveCommentButton.addEventListener('click', async () => {
                console.log('Save button clicked');
                try {
                    // Capture the comment text from the textarea
                    const commentText = commentTextarea.value;
                    
                    // Check if there's a current invoice ID
                    if (!currentInvoiceId) {
                        console.error('No current invoice selected.');
                        return;
                    }
                    
                    // Make an API request to update the comment in the database
                    const response = await fetch(`https://dashboard-function-app-1.azurewebsites.net/api/updateComments?code=d2O6a2c4ZB-XRtNhCCm5bxtSye0viZVQ-bog5Q9NpvO3AzFuhig-iQ==`, {
                        method: 'POST', // Use the appropriate HTTP method (e.g., PUT) for updating data
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ invoiceId: currentInvoiceId, comment: commentText }),
                    });

                    if (!response.ok) {
                        throw new Error('Error updating comment.');
                    }

                    // After successfully updating the comment in the database, you may want to refresh the table to reflect the updated comment.
                    // You can call a function to fetch and display the data for the selected table or view here.

                    // Close the modal
                    commentModal.style.display = 'none';

                    window.location.reload();
                } catch (error) {
                    console.error('Error saving comment:', error);
                }
            });

            // Event listener for the modal's close button
            commentModal.addEventListener('click', (event) => {
                if (event.target === commentModal) {
                    commentModal.style.display = 'none';
                }
            });

            // Function to close the modal when the close button in the modal header is clicked
            document.querySelector('.modal-header .close').addEventListener('click', () => {
                commentModal.style.display = 'none';
            });


            // // Function to apply styling to rows based on conditions
            // function applyRowStyling(data) {
            //     const tableBody = document.querySelector('#dataTable tbody');
            //     const currentDate = new Date(); // Get the current date

            //     data.forEach((rowData) => {
            //         const row = tableBody.querySelector(`tr[data-invoice-id="${rowData.invoice_id}"]`);
            //         if (row) {
            //             const amountDue = parseFloat(rowData.amount_due);
            //             const amountPaid = parseFloat(rowData.amount_paid);

            //             // Assuming the month is stored as a number in rowData.month
            //             const invoiceMonth = parseInt(rowData.month, 10);
            //             const currentMonth = currentDate.getMonth() + 1; // JavaScript months are 0-based

            //             if (amountPaid < amountDue && currentMonth >= invoiceMonth) {
            //                 // Apply the light red background to the row
            //                 row.classList.add('red-background');
            //             } else {
            //                 // Remove the red background if not applicable
            //                 row.classList.remove('red-background');
            //             }
            //         }
            //     });
            // }


            
        });


    </script>
</body>
</html>
